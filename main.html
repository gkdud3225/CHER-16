<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="style.css" type="text/css">
  <title>Main</title>
</head>

<body>
  <script type="text/javascript">
    const key = function(){
      window.crypto.subtle.generateKey({
            name: "AES-CBC",
            length: 256,
          },
          false, ["encrypt", "decrypt"]
        ).then(function(key) {
          console.log(key);
        }).catch(function(err) {
          console.error(err);
        });
    };

    function aesEncrypt() {
      var data = document.getElementById("input").value; // 암호화할 데이터
      window.crypto.subtle.encrypt({
          name: "AES-CBC",
          iv: window.crypto.getRandomValues(new Unit8Array(16)),
        },
        key,
        data
      ).then(function(encrypted) {
        console.log(new Uint8Array(encrypted));
      }).catch(function(err) {
        console.error(err);
      });
    }

    function indexedDBCheck() {
      if (!window.indexedDB) { // indexedDB 브라우저 지원여부 확인
        window.alert("Your browser doesn't support a indexedDB.");
      }
      var dbName = "keyDB";
      var dbVersion = 1.0;
      var db;
      var objectStore;
      var openRequest = window.indexedDB.open(dbName, dbVersion); // DB Open

      openRequest.onupgradeneeded = function(e) { // db 생성 또는 버전 업그레이드시 수행
        console.log("onupgradeneeded");
        db = e.target.result;
        if (!db.objectStoreNames.contains("keyTable")) { // "keyTable" object Store 생성
          objectStore = db.createObjectStore("keyTable", {keyPath: "key"});
        }
        objectStore.add(key);
      };

      openRequest.onsuccess = function(e) {
        console.log("onsuccess");
        db = e.target.result;
        var transaction = db.transaction(["keyTable"], "readwrite");
        objectStore = transaction.objectStore("keyTable");
        var getRequest = objectStore.get("key");
        getRequest.onerror = function(e){
          console.log("error", e.target.error.name);
        };
        getRequest.onsuccess = function(e){
          console.log("get success");
          console.log(e);
        };

        // var addRequest = objectStore.add();
        // addRequest.onerror = function(e){
        //   console.log("error", e.target.error.name);
        // };
        // addRequest.onsuccess = function(e){
        //   console.log("add success");
        // };
      };
      openRequest.onerror = function(e){
        console.log("error");
        console.error(e);
      };
    }

  </script>

  <h2>Key</h2>
  <div id="key"></div>
  <div><h2>입력</h2><input type="text" id="input"></div>
  <h2>출력</h2><div id="output"></div>
  <div id="stepButton">
    <input type="button" id="step1" value="STEP1" onclick="indexedDBCheck()"></input>
    <input type="button" id="step2" value="STEP2" ></input>
    <input type="button" id="step3" value="STEP3"></input>
  </div>
</body>

</html>
